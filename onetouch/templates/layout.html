<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.png') }}">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!--<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel="stylesheet">
    <!-- <script src="https://kit.fontawesome.com/6acaa27a4b.js" crossorigin="anonymous"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- selet2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='mikicustom.css') }}">

    <style>
      #sidebar { transition: margin-left 0.3s; overflow-x: hidden; }
      #sidebar.active { margin-left: -300px; }
      .sidebar-active #navbarToggle .navbar-nav li { display: none; }
      .navbar-nav .nav-item { opacity: 0; transition: opacity 0.5s ease; }
      .navbar-nav .nav-item.hidden { opacity: 0; pointer-events: none; }
    </style>

    {% if title %}
      <title>OneTouch - {{ title }}</title>
    {% else %}
      <title>OneTouch</title>
    {% endif %}


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  </head>
  <body class="{{ route_name }}">
    <header class="site-header">
      <nav class="navbar navbar-expand-md navbar-dark bg-steel">

        {% if current_user.is_authenticated %}
        <button type="button" id="sidebarToggle" style="background: transparent; border: none;">
          <i class="fa-solid fa-bars awesomedelete" style="color: white;"></i>
        </button>
        {% endif %}

        <div class="container">
          {% if current_user.is_authenticated %}
          <div class="col">
            <a class="navbar-brand mr-4" href="{{url_for('main.home')}}">{{ current_user.user_school.school_name }} | {{ current_user.user_name }}</a>
            <a class="navbar-brand mr-4" href="{{url_for('main.news')}}" title="Novosti"><i class="fa-solid fa-newspaper"></i></a>
            <!-- <a class="navbar-brand mr-4" href="{{url_for('main.instructions')}}" title="Upustva"><i class="fa-solid fa-book"></i></a> -->
          </div>
          {% endif %}
          <div class="collapse navbar-collapse" id="navbarToggle">
            <!-- Navbar Right Side -->
            <div class="navbar-nav">
              {% if current_user.is_authenticated %}
                <li class="nav-item dropdown dropdown--align-right">
                  <a class="nav-link dropdown-toggle" href="" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Podaci</a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item loading" href="{{ url_for('students.student_list') }}">Uƒçenici</a>
                    <a class="dropdown-item loading" href="{{ url_for('teachers.teacher_list') }}">Odeljenske stare≈°ine</a>
                    <a class="dropdown-item loading" href="{{ url_for('schools.school_profile') }}">Podaci ≈°kole</a>
                    {% if current_user.user_role == 'admin' %}
                    <a class="dropdown-item loading" href="{{ url_for('main.users') }}">Korisnici</a>
                    {% endif %}
                    <a class="dropdown-item loading" href="{{ url_for('suppliers.supplier_list') }}">Dobavljaƒçi</a>
                    <a class="dropdown-item loading" href="{{ url_for('suppliers.service_list') }}">Tip usluge</a>
                    <a class="dropdown-item loading" href="{{ url_for('suppliers.service_profile_list') }}">Detalji usluge</a>
                  </div>
                </li>
                <li class="nav-item dropdown dropdown--align-right">
                  <a class="nav-link dropdown-toggle" href="" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Knji≈æenje</a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item loading" href="{{ url_for('transactions.student_debts') }}">Zadu≈æivanje uƒçenika</a>
                    <a class="dropdown-item loading" href="{{ url_for('transactions.posting_payment') }}">Knji≈æenje uplata</a>
                    <a class="dropdown-item loading" href="{{ url_for('transactions.transfer_funds') }}">Preknji≈æavanje</a>
                  </div>
                </li>
                <li class="nav-item dropdown dropdown--align-right">
                  <a class="nav-link dropdown-toggle" href="" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pregled</a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item loading" href="{{ url_for('overviews.overview_students') }}">Uƒçenik</a>
                    <a class="dropdown-item loading" href="{{ url_for('overviews.overview_sections') }}">≈†kola</a>
                    <a class="dropdown-item loading" href="{{ url_for('overviews.overview_debts') }}">Dugovanja uƒçenika</a>
                  </div>
                </li>
                <li class="nav-item dropdown dropdown--align-right mr-4">
                  <a class="nav-link dropdown-toggle" href="" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Arhiva</a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item loading" href="{{ url_for('transactions.debts_archive_list') }}">Arhiva naloga</a>
                    <a class="dropdown-item loading" href="{{ url_for('transactions.payments_archive_list') }}">Arhiva izvoda</a>
                    <a class="dropdown-item loading" href="{{ url_for('transactions.transfers_list') }}">Arhiva preknji≈æavanja</a>
                  </div>
                </li>
                <!-- <i class="fa-solid fa-window-minimize fa-rotate-90 awesomedelete mt-2" style="color: white;"></i> -->
                <a class="nav-item nav-link" href="{{ url_for('users.logout') }}" style="opacity: 1;">Odjavite se</a>
              {% else %}
                <!-- <a class="nav-item nav-link" href="{{ url_for('users.login') }}" style="opacity: 1;"> Prijavite se</a> -->
              {% endif %}
            </div>
          </div>
        </div>
      </nav>
    </header>
    <legend class="">{{ legend | safe }}</legend>
    <div class="wrapper d-flex align-items-stretch">
      
      {% if current_user.is_authenticated %}
      <!-- Podrazumevano je sakriven (active klasa) -->
      <nav id="sidebar" class="active">
        <script>
          // Izvr≈°ava se ODMAH - postavi sidebar i navbar items u pravo stanje
          (function() {
            var sidebarState = localStorage.getItem("sidebarActive");
            var sidebar = document.getElementById('sidebar');
            
            // Ako sidebarActive NIJE "true" (null ili "false"), sidebar treba biti vidljiv
            if (sidebarState !== "true" && sidebar) {
              sidebar.classList.remove('active');
              // Sidebar je vidljiv ‚Üí sakrij navbar items (osim logout)
              var navbarItems = document.querySelectorAll(".navbar-nav .nav-item");
              navbarItems.forEach(function(item) {
                if (!item.querySelector('a[href*="logout"]')) {
                  item.style.opacity = "0";
                  item.classList.add("hidden");
                }
              });
            } else {
              // Sidebar je sakriven ‚Üí prika≈æi navbar items
              var navbarItems = document.querySelectorAll(".navbar-nav .nav-item");
              navbarItems.forEach(function(item) {
                item.style.opacity = "1";
                item.classList.remove("hidden");
              });
            }
          })();
        </script>
        <div class="p-4 pt-5">
          <!--<a href="{{url_for('main.home')}}"><img src="{{ url_for('static', filename='img/logo.png') }}" class="login-logo" style="width: 95%;"></a>-->
          <div class="accordion leftcolacc" id="accordionMenu">
            <!--<a href="{{ url_for('main.home') }}" class="homelink">Poƒçetna strana</a>-->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  Podaci
                </button>
              </h2>
              <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionMenu">
                <div class="accordion-body">
                  <a class="nav-item nav-link loading" href="{{ url_for('students.student_list') }}" id="student_list">Uƒçenici</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('teachers.teacher_list') }}" id="teacher_list">Odeljenske stare≈°ine</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('schools.school_profile') }}" id="school">Podaci ≈°kole</a>
                  {% if current_user.user_role == 'admin' %}
                  <a class="nav-item nav-link loading" href="{{ url_for('main.users') }}" id="users">Korisnici</a>
                  {% endif %}
                  <a class="nav-item nav-link loading" href="{{ url_for('suppliers.supplier_list') }}" id="supplier_list">Dobavljaƒçi</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('suppliers.service_list') }}" id="service_list">Tip usluge</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('suppliers.service_profile_list') }}" id="service_profile_list">Detalji usluge</a>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  Knji≈æenje
                </button>
              </h2>
              <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionMenu">
                <div class="accordion-body">
                  <a class="nav-item nav-link loading" href="{{ url_for('transactions.student_debts') }}" id="student_debts">Zadu≈æivanje uƒçenika</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('transactions.posting_payment') }}" id="posting_payment">Knji≈æenje uplata</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('transactions.transfer_funds') }}" id="transfer_funds">Preknji≈æavanje</a>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  Pregled
                </button>
              </h2>
              <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionMenu">
                <div class="accordion-body">
                  <a class="nav-item nav-link loading" href="{{ url_for('overviews.overview_students') }}" id="overview_students">Uƒçenik</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('overviews.overview_sections') }}" id="overview_sections">≈†kola</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('overviews.overview_debts') }}" id="overview_debts">Dugovanja uƒçenika</a>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                  Arhiva
                </button>
              </h2>
              <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionMenu">
                <div class="accordion-body">
                  <a class="nav-item nav-link loading" href="{{ url_for('transactions.debts_archive_list') }}" id="debts_archive_list">Arhiva naloga</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('transactions.payments_archive_list') }}" id="payments_archive_list">Arhiva izvoda</a>
                  <a class="nav-item nav-link loading" href="{{ url_for('transactions.transfers_list') }}" id="transfers_list">Arhiva preknji≈æavanja</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      {% endif %}

      <main role="main" class="container">
        <div class="row">
          <div class="col-md-12">
            <!--<legend class="">{{ legend | safe }}</legend>-->
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}
            {% block content %}{% endblock %}
            <div class="loading-overlay">
              <div class="spinner"></div>
              <div>   Molim Vas saƒçekajte...</div>
            </div>
          </div>
        </div>
      </main>
      
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <!-- <script type="text/javascript" charset="utf8" src="file:///D:/Mihas/Programming/ython/Projects/PutniNalozi/putninalozi/js/jquery.dataTables.js"></script> -->

    <!-- "file:///D:/Mihas/Programming/ython/Projects/PutniNalozi/putninalozi/js/jquery.dataTables.js" -->

    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    {% block scripts %}{% endblock %}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
          // Get the sidebar and button elements
          var sidebar = document.getElementById("sidebar");
          var sidebarToggle = document.getElementById("sidebarToggle");
  
          // Inicijalno stanje je veƒá postavljeno inline script-om
          // Ovde samo setup-ujemo toggle funkcionalnost
  
          // Function to toggle the sidebar and update localStorage
          function toggleSidebar() {
              // Toggle the 'active' class on the sidebar
              sidebar.classList.toggle("active");
  
              // Store the state in localStorage
              localStorage.setItem("sidebarActive", sidebar.classList.contains("active"));
  
              // Check if the sidebar is active and update the visibility of li elements
              var navbarItems = document.querySelectorAll(".navbar-nav .nav-item");
  
              // Check if the sidebar is active
              if (sidebar.classList.contains("active")) {
                  // Fade in one by one from right to left
                  navbarItems.forEach(function (item, index) {
                    setTimeout(function () {
                            item.classList.remove("hidden");
                            item.style.opacity = "1";
                        }, (navbarItems.length - index - 1) * 100); // Podesite vreme zaka≈°njenja po potrebi
                  });
              } else {
                  // Fade out one by one from left to right
                  for (let i = 0; i < navbarItems.length - 1; i++) {
                      setTimeout(function () {
                          navbarItems[i].classList.add("hidden");
                          navbarItems[i].style.opacity = "0";
                      }, i * 100); // Adjust the delay time as needed
                  }
              }
          }
  
          // Add a click event listener to the button
          sidebarToggle.addEventListener("click", toggleSidebar);
      });
    </script>

    <script>
      // skripta koja porkeƒáe div.loading-overlay kod dugmiƒáa koji u class imaju "loading" 
      //a slu≈æi za dugmiƒáe koje zahtevaju du≈æi rad u backendu kako bi onemoguƒáili korisniku da klikne  neko dugme dok se ne izv≈°i funkcija u bakendu
      $(document).ready(function () {
        // Dodajte klasu "active" na overlay kada zapoƒçne uƒçitavanje stranice
        $('.loading').click(function() {
          $(".loading-overlay").addClass("active");
        })
  
        // Uklonite klasu "active" kada je stranica potpuno uƒçitana
        $(window).on("load", function () {
          $(".loading-overlay").removeClass("active");
        });

        // NOVO: Ukloni spinner i kada se vrati iz ke≈°a
        window.addEventListener('pageshow', function(event) {
          $(".loading-overlay").removeClass("active");
  });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      document.querySelector(".loading-overlay").classList.add("active");
    });
    window.addEventListener("load", function() {
      document.querySelector(".loading-overlay").classList.remove("active");
    });
  </script>
  <script>
		$(document).ready(function(){
			// Get the current URL
			var url = window.location.href;

			// Define a mapping of keywords/identifiers to sections and link IDs
			var mapping = {
				"student_list": { section: '#collapseOne', link: '#student_list' },
				"teacher_list": { section: '#collapseOne', link: '#teacher_list' },
        "school": { section: '#collapseOne', link: '#school' },
        "users": { section: '#collapseOne', link: '#users' },
        "supplier_list": { section: '#collapseOne', link: '#supplier_list' },
        "service_list": { section: '#collapseOne', link: '#service_list' },
        "service_profile_list": { section: '#collapseOne', link: '#service_profile_list' },
				"student_debts": { section: '#collapseTwo', link: '#student_debts' },
        "posting_payment": { section: '#collapseTwo', link: '#posting_payment' },
        "transfer_funds": { section: '#collapseTwo', link: '#transfer_funds' },
				"overview_students": { section: '#collapseThree', link: '#overview_students' },
        "overview_sections": { section: '#collapseThree', link: '#overview_sections' },
        "overview_student": { section: '#collapseThree', link: '#overview_student' },
        "overview_debts": { section: '#collapseThree', link: '#overview_debts' },
        "debts_archive_list": { section: '#collapseFour', link: '#debts_archive_list' },
        "payments_archive_list": { section: '#collapseFour', link: '#payments_archive_list' },
        "payment_archive": { section: '#collapseFour', link: '#payment_archive' },
        "debt_archive": { section: '#collapseFour', link: '#debt_archive' },
        "transfers_list": { section: '#collapseFour', link: '#transfers_list' },
			};

			// Check if the URL contains a keyword/identifier from the mapping
			for (var key in mapping) {
				if (url.indexOf(key) > -1) {
					$(mapping[key].section).addClass('show');
					$(mapping[key].link).addClass('active-link');
					break; // Exit the loop once a match is found
				}
			}
		});
	</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
      // Uzmite trenutni URL
      var currentPath = window.location.pathname;

      // Uzmite sve podstavke u meniju sa klasom 'dropdown-item'
      var menuItems = document.querySelectorAll('.dropdown-item');

      // Iterirajte kroz sve podstavke u meniju
      menuItems.forEach(function (menuItem) {
          var href = menuItem.getAttribute('href');

          // Proverite da li trenutni URL taƒçno odgovara href vrednosti
          if (href && currentPath === href) {
              // Dodajte klasu 'active' na aktivnu podstavku
              menuItem.classList.add('active');

              // Dodajte klasu 'active' i na glavnu stavku (roditeljski element <li> ili <a>)
              var parentDropdown = menuItem.closest('li').querySelector('.nav-link');
              if (parentDropdown) {
                  parentDropdown.classList.add('active');
              }
          }
      });
  });
</script>
    {% if current_user.user_role == 'admin' %}
      <!-- Marked.js library for markdown parsing -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
      <!-- Floating chat widget -->

      <div id="chatWidget">
        <button id="chatToggle" title="AI Asistent">üí¨</button>
        
        <div id="chatPopup">
            <div class="resize-handle" id="resizeHandle"></div>
            <div class="chat-header">
                <h4>AI Asistent</h4>
                <button class="chat-close" id="chatClose">&times;</button>
            </div>
            
            <div class="chat-body" id="chatBody">
                <div class="chat-message assistant">
                    <div class="chat-bubble">
                        Zdravo! Ja sam AI asistent. Pitajte me bilo ≈°ta o uƒçenicima, dugovima ili uplatama.
                    </div>
                </div>
            </div>
            
            <div class="chat-footer">
                <input type="text" 
                      class="chat-input" 
                      id="chatInput" 
                      placeholder="Unesite poruku...">
                <button class="chat-send-btn" id="chatSendBtn">
                    <i class="fa fa-paper-plane"></i>
                </button>
            </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatToggle = document.getElementById('chatToggle');
            const chatPopup = document.getElementById('chatPopup');
            const chatClose = document.getElementById('chatClose');
            const chatBody = document.getElementById('chatBody');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
        
            // Configure Marked.js (Markdown parser)
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,   // Pretvori nove redove u <br>
                    gfm: true,      // GitHub-flavored markdown
                    tables: true    // Omoguƒái tabele
                });
            }
        
            // Toggle chat popup
            chatToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                chatPopup.classList.toggle('show');
                if (chatPopup.classList.contains('show')) {
                    chatInput.focus();
                }
            });
        
            chatClose.addEventListener('click', function() {
                chatPopup.classList.remove('show');
            });

            // Zatvori popup ako se klikne izvan njega
            document.addEventListener('click', function(e) {
                if (chatPopup.classList.contains('show') && 
                    !chatPopup.contains(e.target) && 
                    e.target !== chatToggle) {
                    chatPopup.classList.remove('show');
                }
            });

            // Spreƒçi zatvaranje ako se klikne unutar popup-a
            chatPopup.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            // Custom resize funkcionalnost - resize handle u gornjem levom uglu
            const resizeHandle = document.getElementById('resizeHandle');
            let isResizing = false;
            let startX, startY, startWidth, startHeight, startRight, startBottom;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = chatPopup.getBoundingClientRect();
                startWidth = rect.width;
                startHeight = rect.height;
                startRight = window.innerWidth - rect.right;
                startBottom = window.innerHeight - rect.bottom;
                
                e.preventDefault();
                e.stopPropagation();
            });

            resizeHandle.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaX = startX - e.clientX;
                const deltaY = startY - e.clientY;
                
                const newWidth = Math.max(380, startWidth + deltaX);
                const newHeight = Math.max(550, startHeight + deltaY);
                
                chatPopup.style.width = newWidth + 'px';
                chatPopup.style.height = newHeight + 'px';
                chatPopup.style.right = startRight + 'px';
                chatPopup.style.bottom = startBottom + 'px';
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
            });
        
            // Add message to chat (AI podr≈æava Markdown)
            function addMessage(text, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
        
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
        
                // Ako je AI (assistant), konvertuj Markdown u HTML
                if (!isUser && typeof marked !== 'undefined') {
                    bubble.innerHTML = marked.parse(text);
                } else {
                    bubble.textContent = text;
                }
        
                messageDiv.appendChild(bubble);
                chatBody.appendChild(messageDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        
            // Typing indicator
            function showTyping(show) {
                let typing = document.querySelector('.typing-indicator');
                if (show) {
                    if (!typing) {
                        typing = document.createElement('div');
                        typing.className = 'typing-indicator';
                        typing.innerHTML = '<span></span><span></span><span></span>';
                        chatBody.appendChild(typing);
                    }
                    typing.classList.add('show');
                } else {
                    if (typing) {
                        typing.classList.remove('show');
                        setTimeout(() => typing.remove(), 300);
                    }
                }
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        
            // Send message to backend
            const chatUrl = "{{ url_for('ai_agent.chat') }}";
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
        
                addMessage(message, true);
                chatInput.value = '';
                chatSendBtn.disabled = true;
                showTyping(true);
        
                try {
                    // Dinamiƒçki koristi URL koji Flask generi≈°e
                    const response = await fetch(chatUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    });
        
                    const data = await response.json();
                    showTyping(false);
        
                    if (data.success) {
                        addMessage(data.message, false);
                    } else {
                        addMessage('Gre≈°ka: ' + data.message, false);
                    }
                } catch (error) {
                    showTyping(false);
                    addMessage('Do≈°lo je do gre≈°ke pri komunikaciji sa serverom.', false);
                    console.error('Error:', error);
                } finally {
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                }
            }
        
            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
        </script>
    {% endif %}
  </body>
</html>
