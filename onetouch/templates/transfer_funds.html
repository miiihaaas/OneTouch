{% extends "layout.html" %}
{% block content %}
<style>
    .negative-balance {
        color: green;
    }
    .positive-balance {
        color: red;
    }
    .section-divider {
        border-top: 2px solid #dee2e6;
        margin: 30px 0;
    }
</style>

<!-- Izbor učenika -->
<div class="form-group">
    <label for="student_select">Izaberite učenika:</label>
    <select id="student_select" class="form-select select2-searchable">
        <option value="">Izaberite učenika</option>
        {% for student in students %}
        <option value="{{ student.id }}" {% if selected_student_id == student.id %}selected{% endif %}>
            {{ student.student_name }} {{ student.student_surname }} ({{ student.student_class }}/{{ student.student_section }})
        </option>
        {% endfor %}
    </select>
</div>

{% if services_data %}
<div class="card mt-4">
    <div class="card-header">
        <h3>
            Stanje usluga za učenika: {{ selected_student.student_name }} {{ selected_student.student_surname }} 
            <a href="{{url_for('overviews.overview_student', student_id=selected_student_id)}}" title="Pregled kartice stanja" style="float: right;">
                <i class="fa fa-magnifying-glass awesomeedit"></i>
            </a>
        </h3>
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usluga</th>
                    <th>Ukupno zaduženje</th>
                    <th>Ukupno uplaćeno</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for service in services_data %}
                <tr>
                    <td>{{ "%03d"|format(service.service_id) }}</td>
                    <td>{{ service.service_item.service_item_service.service_name }} - {{ service.service_item.service_item_name }}</td>
                    <td>{{ service.debt_amount|round(2) }}</td>
                    <td>{{ service.payment_amount|round(2) }}</td>
                    <td {% if service.saldo > 0 %}class="positive-balance"{% elif service.saldo < 0 %}class="negative-balance"{% endif %}>
                        {{ service.saldo|round(2) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-right">Ukupno:</th>
                    <th {% if services_data|sum(attribute='saldo') > 0 %}class="positive-balance"{% elif services_data|sum(attribute='saldo') < 0 %}class="negative-balance"{% endif %}>
                        {{ services_data|sum(attribute='saldo')|round(2) }}
                    </th>
                </tr>
            </tfoot>
        </table>

        <!-- SEKCIJA 1: Preknjižavanje sa usluge na uslugu -->
        <h4 class="mt-4 mb-3">1. Preknjižavanje sa usluge na uslugu</h4>
        <form method="POST" action="{{ url_for('transactions.transfer_funds') }}">
            <input type="hidden" name="student_id" value="{{ selected_student_id }}">
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="source_service">Sa usluge (izvor):</label>
                    <select name="source_service" id="source_service" class="form-select" required>
                        <option value="">Izaberite uslugu sa koje se preknjižava (u preplati)</option>
                        {% for service in services_with_surplus %}
                        <option value="{{ service.service_id }}" data-max="{{ (-service.saldo)|round(2) }}">
                            {{ service.service_item.service_item_service.service_name }} - {{ service.service_item.service_item_name }} 
                            (u preplati: {{ (-service.saldo)|round(2) }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="target_service">Na uslugu (cilj):</label>
                    <select name="target_service" id="target_service" class="form-select" required>
                        <option value="">Izaberite uslugu na koju se preknjižava</option>
                        {% for service in services_with_debt %}
                        {% if service.service_id != source_service_id %}
                        <option value="{{ service.service_id }}">
                            {{ service.service_item.service_item_service.service_name }} - {{ service.service_item.service_item_name }}
                            (dug: {{ service.saldo|round(2) }})
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="amount">Iznos za preknjižavanje:</label>
                    <input type="number" name="amount" id="amount" class="form-control" step="0.01" min="0.01" required>
                </div>
                <div class="col-md-6">
                    <label for="transfer_note">Napomena (opciono):</label>
                    <input type="text" name="transfer_note" id="transfer_note" class="form-control" maxlength="255">
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Izvršite preknjižavanje</button>
        </form>

        <!-- Razdelnik -->
        <div class="section-divider"></div>

        <!-- SEKCIJA 2: Rasknjižavanje dugovanja -->
        <h4 class="mt-4 mb-3">2. Rasknjižavanje dugovanja (oprost duga)</h4>
        <form method="POST" id="writeOffForm" action="{{ url_for('transactions.write_off_debt') }}">
            <input type="hidden" name="student_id" value="{{ selected_student_id }}">
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="debt_service">Usluga sa dugom:</label>
                    <select name="debt_service" id="debt_service" class="form-select" required>
                        <option value="">Izaberite uslugu za rasknjižavanje</option>
                        {% for service in services_with_debt %}
                        <option value="{{ service.service_id }}" data-debt="{{ service.saldo|round(2) }}">
                            {{ service.service_item.service_item_service.service_name }} - {{ service.service_item.service_item_name }}
                            (dug: {{ service.saldo|round(2) }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="writeoff_amount">Iznos za rasknjižavanje:</label>
                    <input type="number" name="writeoff_amount" id="writeoff_amount" class="form-control" step="0.01" min="0.01" required>
                    <small class="form-text text-muted">Maksimalni iznos: <span id="max_debt_display">0.00</span></small>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="writeoff_note">Razlog rasknjižavanja (opciono):</label>
                    <input type="text" name="writeoff_note" id="writeoff_note" class="form-control" maxlength="255" placeholder="Npr. Oprost duga, socijalni slučaj, itd.">
                </div>
            </div>

            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#WriteOffModal" onclick="prepareWriteOff()">Rasknjiži dugovanje</button>
        </form>
    </div>
</div>
{% endif %}

<!-- Modal za potvrdu rasknjižavanja sa lozinkom -->
<div class="modal fade" id="WriteOffModal" tabindex="-1" role="dialog" aria-labelledby="WriteOffModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="WriteOffModalLabel">Potvrda rasknjižavanja dugovanja</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="writeoff_confirmation_text">Da biste rasknjižili dugovanje potrebno je potvrditi svojom lozinkom:</p>
                <input class="form-control" type="password" id="writeoff_password" name="writeoff_password" placeholder="Unesite lozinku">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Otkažite</button>
                <button class="btn btn-danger" type="button" onclick="submitWriteOff()">Potvrdite rasknjižavanje</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Inicijalizacija Select2 za polje izbora učenika
        $('.select2-searchable').select2({
            theme: "classic",
            placeholder: "Izaberite učenika...",
            allowClear: true,
            width: '100%'
        });
        
        // Promena učenika
        $('#student_select').on('change', function() {
            if ($(this).val()) {
                window.location.href = "{{ url_for('transactions.transfer_funds') }}/" + $(this).val();
            }
        });

        // Ažuriranje maksimalnog iznosa dugovanja
        $('#debt_service').on('change', function() {
            const selectedOption = $(this).find('option:selected');
            const maxDebt = selectedOption.data('debt');
            
            if (maxDebt) {
                $('#max_debt_display').text(parseFloat(maxDebt).toFixed(2));
                $('#writeoff_amount').attr('max', maxDebt);
            } else {
                $('#max_debt_display').text('0.00');
                $('#writeoff_amount').removeAttr('max');
            }
        });
    });

    // Priprema modala za rasknjižavanje
    function prepareWriteOff() {
        const debtService = $('#debt_service').val();
        const writeoffAmount = $('#writeoff_amount').val();
        
        if (!debtService) {
            alert('Morate izabrati uslugu sa dugom.');
            $('#WriteOffModal').modal('hide');
            return false;
        }
        
        if (!writeoffAmount || parseFloat(writeoffAmount) <= 0) {
            alert('Morate uneti validan iznos za rasknjižavanje.');
            $('#WriteOffModal').modal('hide');
            return false;
        }
        
        const maxDebt = parseFloat($('#debt_service').find('option:selected').data('debt'));
        if (parseFloat(writeoffAmount) > maxDebt) {
            alert('Iznos za rasknjižavanje ne može biti veći od trenutnog duga (' + maxDebt.toFixed(2) + ').');
            $('#WriteOffModal').modal('hide');
            return false;
        }
        
        // Očisti prethodno unesenu lozinku
        $('#writeoff_password').val('');
    }

    // Slanje forme za rasknjižavanje
    function submitWriteOff() {
        const password = $('#writeoff_password').val();
        
        if (!password) {
            alert('Morate uneti lozinku.');
            return false;
        }
        
        // Dodaj lozinku u formu
        const form = $('#writeOffForm');
        
        // Ukloni staro polje za lozinku ako postoji
        form.find('input[name="password"]').remove();
        
        // Dodaj novo polje za lozinku
        $('<input>').attr({
            type: 'hidden',
            name: 'password',
            value: password
        }).appendTo(form);
        
        // Submituj formu
        form.submit();
    }
</script>
{% endblock %}
