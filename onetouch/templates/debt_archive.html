{% extends "layout.html" %}
{% block content %}
<style>
    @media (max-width: 991px)  {
        .mobtable td:nth-of-type(1):before { content: "Selektujte"; }
        .mobtable td:nth-of-type(2):before { content: "Učenik"; }
        .mobtable td:nth-of-type(3):before { content: "Poziv na broj"; }
        .mobtable td:nth-of-type(4):before { content: "Detalji usluge"; }
        .mobtable td:nth-of-type(5):before { content: "Količina"; }
        .mobtable td:nth-of-type(6):before { content: "Iznos"; }
        .mobtable td:nth-of-type(7):before { content: "Olakšica"; }
        .mobtable td:nth-of-type(8):before { content: "Iznos zaduženja"; }
        .mobtable td:nth-of-type(9):before { content: "Akcije"; }
    }
</style>
{% if teacher %}
<h1>Odeljenski starešina: {{ teacher.teacher_name }} {{ teacher.teacher_surname }}</h1>
{% endif %}
<div class="form-group" style="display: inline-block;">
    <label for="classes" class="form-control-label">Razred</label>
    <input id="classes" name="classes" type="text" class="form-control" value="{{ debt.debt_class }}" disabled>
</div>
<div class="form-group" style="display: inline-block;">
    <label for="section" class="form-control-label">Odeljenje</label>
    <input id="section" name="section" type="text" class="form-control" value="{{ debt.debt_section }}" disabled>
</div>
<div class="form-group" style="display: inline-block;">
    <label for="installment" class="form-control-label">Rata</label>
    <input id="installment" name="installment" type="text" class="form-control" value="{{ debt.installment_number }}" disabled>
</div>
<div class="form-group" style="display: inline-block;">
    <label for="today_date" class="form-control-label">Datum zaduživanja</label>
    <input id="today_date" name="today_date" type="text" class="form-control" value="{{ debt.student_debt_date.strftime('%d.%m.%Y.') }}" disabled>
</div>
<div class="form-group cstm-4" style="display: inline-block; position: relative; top: -2px;">
    <!-- <a id="resetButton" class="btn btn-primary" href="{{ url_for('static', filename='reports/debt_report.pdf') }}" target="_blank"><i class="fa-solid fa-print big-print"></i></a> -->
    <a id="resetButton" class="btn btn-primary" href="{{ url_for('transactions.get_report', filename='debt_report.pdf') }}" target="_blank"><i class="fa-solid fa-print big-print"></i></a>
</div>
{% if new_students %}
<div class="form-group" style="display: inline-block;">
    <a class="btn btn-primary" data-toggle="modal" data-target="#AddStudent">zadužite novog učenika</a>
</div>
<!-- add new student modal -->
<div class="modal fade" id="AddStudent" tabindex="-1" role="dialog" aria-labelledby="AddStudentLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="AddStudentLabel">Zaduživanje novog učenika</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('transactions.add_new_student') }}" method="post">
                <div class="modal-body">
                    <input type="text" name="student_debt_id" value="{{ records[0].student_debt_id }}" readonly style="display: none;">
                    <input type="text" name="service_item_id" value="{{ records[0].service_item_id }}" readonly style="display: none;">
                    <input type="text" name="student_debt_installment_number" value="{{ records[0].student_debt_installment_number }}" readonly style="display: none;">
                    <input type="text" name="studetn_debt_installment_value" value="{{ records[0].studetn_debt_installment_value }}" readonly style="display: none;">
                    <select class="form-select"  name="student_id" id="student_id">
                        {% for student in new_students %}
                            <option value="{{student.id}}">{{student.student_name}} {{student.student_surname}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Otkažite</button>
                    <button type="submit" class="btn btn-primary loading">Dodajte učenika u listu</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
<hr>
<table id="data" class="table table-striped dataTable no-footer invoices mobtable" role="grid">
    <thead>
        <tr>
            <th style="width: 30px;"><input type="checkbox" id="selectAll" title="Selektujte sve učenike"></th>
            <th>Učenik</th>
            <th>Poziv na broj</th>
            <th>Detalji usluge</th>
            <th style="width: 50px;">Količina</th>
            <th style="width: 80px;">Iznos</th>
            <th style="width: 80px;">Olakšica</th>
            <th style="width: 80px;">Iznos zaduženja</th>
            <th style="width: 80px;"></th>
        </tr>
    </thead>
    <tbody>
        {% for record in records %}
        <tr>
            <td style="text-align: center;">{% if (record.student_debt_amount * record.studetn_debt_installment_value - record.student_debt_discount) > 0 %}<input type="checkbox" class="student-select" data-id="{{ record.id }}" title="Izaberite za grupno štampanje">{% endif %}</td>
            <td><a class="btn btn-primary loading" href="{{url_for('overviews.overview_student', student_id=record.transaction_record_student.id)}}">{{ record.transaction_record_student.student_name }} {{ record.transaction_record_student.student_surname }}</a></td>
            <td>{{ "{:04d}-{:03d}".format(record.student_id, record.service_item_id) }}</td>
            <td>{{ record.transaction_record_student_debt.student_debt_service_item.service_item_service.service_name }} - {{ record.transaction_record_student_debt.student_debt_service_item.service_item_name }}</td>
            <td style="text-align: center;" id="kolicina_{{ record.transaction_record_student.id }}" contenteditable="true" class="edit-cell" data-id="{{ record.transaction_record_student.id }}">{{ record.student_debt_amount }}</td>
            <td style="text-align: right;" id="installment_{{ record.transaction_record_student.id }}">{{ "{:.2f}".format(record.studetn_debt_installment_value) }}</td>
            <td style="text-align: right;" id="olaksice_{{ record.transaction_record_student.id }}" contenteditable="true" class="edit-cell" data-id="{{ record.transaction_record_student.id }}">{{ "{:.2f}".format(record.student_debt_discount)}}</td>
            <td style="text-align: right;" id="iznos_zaduženja_{{ record.transaction_record_student.id }}" class="iznos-zaduzenja">{{ "{:.2f}".format(record.student_debt_amount * record.studetn_debt_installment_value - record.student_debt_discount)}}</td>
            <td  style="text-align: right;">
                {% if (record.student_debt_amount * record.studetn_debt_installment_value - record.student_debt_discount) > 0 %}
                    {% if record.transaction_record_student.send_mail and school.sending_email %}
                    <a class="btn-x btn-primary-x" href="{{url_for('transactions.single_payment_slip', record_id = record.id)}}" target="_blank" title="Generišite uplaticu"><i class="fa-solid fa-print awesomeedit"></i></a>
                    <a
                        href="#"
                        class="btn-x btn-primary-x"
                        data-send-slip="1"
                        data-action-url="{{ url_for('transactions.send_single_payment_slip', record_id=record.id) }}"
                        data-parent-email="{{ record.transaction_record_student.parent_email or '' }}"
                        data-student-name="{{ record.transaction_record_student.student_name }} {{ record.transaction_record_student.student_surname }}"
                        data-already-sent="{% if record.debt_sent %}1{% else %}0{% endif %}"
                        title="{% if record.debt_sent %}Ponovo pošaljite uplatnicu roditelju{% else %}Pošaljite uplatnicu roditelju{% endif %}">
                        {% if record.debt_sent %}
                            <i class="fa-solid fa-envelope awesomedelete"></i>
                        {% else %}
                            <i class="fa-regular fa-envelope awesomedelete"></i>
                        {% endif %}
                    </a>
                    {% else %}
                    <a class="btn-x btn-primary-x" href="{{url_for('transactions.single_payment_slip', record_id = record.id)}}" target="_blank" title="Generišite uplaticu"><i class="fa-solid fa-print awesomeedit"></i></a>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- send all modal -->
<div class="modal fade" id="SendAllModal" tabindex="-1" role="dialog" aria-labelledby="SendAllModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="SendAllModalLabel">Potvrda slanja svim roditeljima</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Da li ste sigurni da želite da pošaljete uplatnice <strong>svim roditeljima</strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Otkažite</button>
                <a id="sendAllConfirmBtn" class="btn btn-primary loading" href="{{ url_for('transactions.send_payment_slips', debt_id=request.view_args['debt_id']) }}">Pošaljite</a>
            </div>
        </div>
    </div>
</div>

<!-- send selected modal -->
<div class="modal fade" id="SendSelectedModal" tabindex="-1" role="dialog" aria-labelledby="SendSelectedModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="SendSelectedModalLabel">Potvrda slanja selektovanim roditeljima</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Da li ste sigurni da želite da pošaljete uplatnice <strong>selektovanim roditeljima</strong>?</p>
                <p class="mt-2 mb-0">Broj selektovanih učenika: <strong id="selectedCountText">0</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Otkažite</button>
                <a id="sendSelectedConfirmBtn" class="btn btn-primary loading" href="#">Pošaljite</a>
            </div>
        </div>
    </div>
</div>

<!-- send slip modal -->
<div class="modal fade" id="SendSlipModal" tabindex="-1" role="dialog" aria-labelledby="SendSlipModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" id="SendSlipModalHeader">
                <h5 class="modal-title" id="SendSlipModalLabel">Potvrda slanja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="SendSlipModalForm" action="" method="post">
                <div class="modal-body">
                    <p id="SendSlipModalText" class="mb-0">Učitavanje detalja...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Otkažite</button>
                    <button type="submit" id="SendSlipModalSubmit" class="btn btn-primary loading">Pošaljite</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="form-group">
            <label for="purpose_of_payment" class="form-control-label">Svrha uplate</label>
            <input type="text" id="purpose_of_payment" class="form-control form-control-lg" value="{{ purpose_of_payment }}">
            <p id="errorMessage" style="display: none;">U polje možete uneti maksimalno 35 karaktera.</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="form-group">
            <label for="student_count" class="form-control-label">Broj zaduženih učenika</label>
            <input type="text" id="student_count" name="student_count" class="form-control form-control-lg" readonly value="0">
        </div>
    </div>
</div>
<div class="form-group">
    <div class="d-flex flex-wrap gap-3 align-items-start">
        <!-- Grupa 1: Glavna akcija -->
        <div class="btn-group-actions">
            <button class="btn btn-primary loading" id="save_button" name="save_button">
                <i class="fa-solid fa-save"></i> Sačuvajte
            </button>
        </div>

        <!-- Grupa 2: PDF Generisanje -->
        <div class="btn-group" role="group" aria-label="PDF generisanje">
            <a class="btn btn-primary" href="{{ url_for('transactions.get_payment_slip', filename='uplatnice.pdf') }}" target="_blank" title="Generišite PDF sa svim uplatnicama">
                <i class="fa-solid fa-file-pdf"></i> Sve uplatnice
            </a>
            <a id="printSelectedBtn" class="btn btn-primary" href="#" title="Generišite PDF samo sa selektovanim uplatnicama">
                <i class="fa-solid fa-file-pdf"></i> Selektovane
            </a>
        </div>

        <!-- Grupa 3: Email slanje -->
        {% if school.sending_email %}
        <div class="btn-group" role="group" aria-label="Email slanje">
            <a id="sendAllBtn" class="btn btn-secondary" href="#" title="Pošaljite mejlove svim roditeljima">
                <i class="fa-solid fa-envelope"></i> Svim roditeljima
            </a>
            <a id="sendSelectedBtn" class="btn btn-secondary" href="#" title="Pošaljite mejlove samo selektovanim roditeljima">
                <i class="fa-solid fa-envelope"></i> Selektovani
            </a>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Dodavanje gap-a između grupa dugmića */
    .gap-3 {
        gap: 1rem !important;
    }

    /* Responsive: Na mobilnim uređajima wrap dugmiće */
    @media (max-width: 768px) {
        .d-flex.flex-wrap {
            flex-direction: column;
        }
        .btn-group {
            width: 100%;
        }
        .btn-group .btn {
            flex: 1;
        }
    }

    /* Vizuelno razdvajanje button groups */
    .btn-group-actions {
        margin-right: 1rem;
    }
</style>

{% endblock content%}

{% block scripts %}
<script>
            // Funkcija za brojanje zaduženih učenika (količina > 0)
        function countChargedStudents() {
            var count = 0;
            var kolicinaElems = document.querySelectorAll('[id^="kolicina_"]');
            
            kolicinaElems.forEach(function(elem) {
                var kolicina = parseFloat(elem.textContent || 0);
                if (kolicina > 0) {
                    count++;
                }
            });
            
            // Ažuriranje polja za prikaz broja zaduženih učenika
            document.getElementById('student_count').value = count;
            return count;
        }
        
$(document).ready(function() {
        // Linkovi za slanje uplatnice: popuni modal i prikaži ga
        $(document).on('click', 'a[data-send-slip="1"]', function (e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            const link = $(this);
            const actionUrl = link.data('action-url');
            const parentEmail = link.data('parent-email') || '';
            const studentName = link.data('student-name') || '';
            const alreadySent = String(link.data('already-sent')) === '1';

            const modal = $('#SendSlipModal');
            modal.find('#SendSlipModalForm').attr('action', actionUrl);

            const safeEmail = parentEmail ? parentEmail : 'nije unet';
            const safeStudent = studentName ? studentName : 'nije izabran';

            const header = modal.find('#SendSlipModalHeader');
            const submitBtn = modal.find('#SendSlipModalSubmit');

            header.removeClass('bg-primary bg-warning bg-danger text-white text-dark');
            submitBtn.removeClass('btn-warning');
            submitBtn.addClass('btn-primary');

            if (alreadySent) {
                modal.find('#SendSlipModalLabel').text('Potvrda ponovnog slanja');
                header.addClass('bg-danger text-dark');
                submitBtn.text('Ponovo pošaljite');
                modal.find('#SendSlipModalText').html(
                    'Da li ste sigurni da želite <strong>ponovo</strong> da generišete i pošaljete uplatnicu roditelju na mejl <strong>' + safeEmail + '</strong> za učenika <strong>' + safeStudent + '</strong>?' 
                );
            } else {
                modal.find('#SendSlipModalLabel').text('Potvrda slanja');
                header.addClass('bg-primary text-white');
                submitBtn.text('Pošaljite');
                modal.find('#SendSlipModalText').html(
                    'Da li ste sigurni da želite da generišete i pošaljete uplatnicu roditelju na mejl <strong>' + safeEmail + '</strong> za učenika <strong>' + safeStudent + '</strong>?' 
                );
            }

            modal.modal('show');
        });

        // Selektovanje/deselektovanje svih učenika
        $('#selectAll').on('change', function() {
            $('.student-select').prop('checked', $(this).prop('checked'));
        });
        
        // Štampanje selektovanih uplatnica
        $('#printSelectedBtn').on('click', function(e) {
            e.preventDefault();

            const selectedIds = [];
            $('.student-select:checked').each(function() {
                selectedIds.push($(this).data('id'));
            });

            if (selectedIds.length === 0) {
                alert('Morate selektovati bar jednog učenika za štampanje uplatnica.');
                return;
            }

            const url = '{{ url_for("transactions.print_selected_slips", debt_id=request.view_args["debt_id"]) }}' + '?ids=' + selectedIds.join(',');
            window.open(url, '_blank');
        });

        // Slanje uplatnica svim roditeljima - otvori modal
        $('#sendAllBtn').on('click', function(e) {
            e.preventDefault();
            $('#SendAllModal').modal('show');
        });

        // Slanje selektovanih uplatnica roditeljima - otvori modal
        $('#sendSelectedBtn').on('click', function(e) {
            e.preventDefault();

            const selectedIds = [];
            $('.student-select:checked').each(function() {
                selectedIds.push($(this).data('id'));
            });

            if (selectedIds.length === 0) {
                alert('Morate selektovati bar jednog učenika za slanje uplatnica.');
                return;
            }

            // Ažuriraj broj selektovanih učenika u modalu
            $('#selectedCountText').text(selectedIds.length);

            // Postavi URL za potvrdu
            const url = '{{ url_for("transactions.send_selected_payment_slips", debt_id=request.view_args["debt_id"]) }}' + '?ids=' + selectedIds.join(',');
            $('#sendSelectedConfirmBtn').attr('href', url);

            $('#SendSelectedModal').modal('show');
        });

        // Kreiranje tabele
        var table = $('#data').DataTable({
            language: {
                url: "//cdn.datatables.net/plug-ins/1.12.1/i18n/sr-SP.json"
            },
            "paging": false, // Isključuje paginaciju
            "lengthMenu": [50, 100, 200, 400, 800],
            "pageLength": 800,
            "columnDefs": [
                { 
                    "orderable": false,
                    "targets": [0, 3]
                }
            ],
            "order": [[4, 'desc']],
        });
        
        // Inicijalno prebrojavanje zaduženih učenika
        countChargedStudents();
        
        // Postavljanje događaja nakon izmjene ćelija "Količina" i "Olakšica"
        $('.edit-cell').on('input', function() {
            var id = $(this).data('id');
            var kolicina = parseFloat($('#kolicina_' + id).text());
            var olaksice = parseFloat($('#olaksice_' + id).text());
            var iznosRate = parseFloat($('#installment_' + id).text());
            console.log('test vrednosti radte: ', parseFloat($('#installment').val()))
            var iznosZaduzenja = (kolicina * iznosRate) - olaksice;
            $('#iznos_zaduženja_' + id).text(iznosZaduzenja.toFixed(2));
            
            // Ažuriraj broj zaduženih učenika nakon svake promene
            countChargedStudents();
        });
        
        const inputFieldPurposeOfPayment = $('#purpose_of_payment');
        const errorMessage = $("#errorMessage");
        const buttonSave = $('#save_button');
        const buttonPrint = $('#print_button');
        inputFieldPurposeOfPayment.on('input', function() {
            if (inputFieldPurposeOfPayment.val() === "") {
                buttonSave.prop('disabled', true);
                errorMessage.hide(); // Sakrijte errorMessage
            } else if (inputFieldPurposeOfPayment.val().length > 35) {
                buttonSave.prop('disabled', true);
                inputFieldPurposeOfPayment.addClass("error-result");
                errorMessage.show(); // Prikazati errorMessage
            } else {
                buttonSave.prop('disabled', false);
                inputFieldPurposeOfPayment.removeClass("error-result"); // Uklonite error klase ako nisu potrebne
                errorMessage.hide(); // Sakrijte errorMessage ako nije potrebno
            }
        });

        buttonSave.on('click', (event) => {
            console.log('test radi - pritisnuto je dugme sačuvaj. nastavi kodiranje')
            var studentDebtId;

            var url = new URL(window.location.href); // Dohvaćanje trenutnog URL-a stranice
            var pathname = url.pathname; // Dohvaćanje putanje URL-a
            var parts = pathname.split('/'); // Razdvajanje putanje na dijelove koristeći "/"
            if (parts.length > 0) {
                var lastPart = parts[parts.length - 1]; // Dohvaćanje posljednjeg dijela putanje
                studentDebtId = parseInt(lastPart); // Pretvaranje posljednjeg dijela u broj
            }
            console.log(studentDebtId); // Ispis studentDebtId u konzoli
            var table = $('#data');
            var rows = table.find('tr');
            console.log('redovi: ', rows)
            console.log('broj redova: ', rows.length)
            
            // Ažuriraj broj zaduženih učenika pre slanja podataka
            countChargedStudents();
            
            var records = []
            for (var i = 1; i < rows.length; i++) {
                // var studentIdCell = rows[i].querySelector('[id^="poziv_na_broj_"]');
                // var studentId = studentIdCell.id.split('_')[3];
                // console.log('student_id: ', studentId)
                
                var quantityCell = rows[i].querySelector('[id^="kolicina_"]');
                var quantity = parseInt(quantityCell.textContent); // ovaj podatak mi treba
                console.log('red: ', quantityCell);
                console.log('red, vrednost količina: ', quantity);

                var studentId = parseInt(quantityCell.getAttribute("id").split("_")[1])
                console.log('student_id: ', studentId)

                // var installmentCell = rows[i].querySelector('[id^="installment_"]');
                // var installmentValue = parseFloat(installmentCell.textContent);
                // console.log('red, vrednost iznos: ', installmentValue);

                var olaksicaCell = rows[i].querySelector('[id^="olaksice_"]');
                var olaksica = parseFloat(olaksicaCell.textContent);
                console.log('red, vrednost olakšica: ', olaksica);

                records.push({
                    'student_id': studentId,
                    'amount': quantity,
                    'discount': olaksica
                })
            }
            console.log('rezultati: ', records)
            const output = {
                'student_debt_id': studentDebtId,
                'purpose_of_payment': inputFieldPurposeOfPayment.val(),
                'records': records,
            }
            console.log('output: ', output)
            console.log(JSON.stringify(output));
            $.ajax({
                url: '{{ url_for("transactions.submit_records") }}',
                method: 'POST',
                data: JSON.stringify(output),
                contentType: 'application/json',
                success: function(response) {
                    // Uspešan AJAX zahtjev
                    // Preusmjeravanje na edit debt stranicu
                    var editDebtUrl = "{{ url_for('transactions.debt_archive', debt_id='1') }}";
                    editDebtUrl = editDebtUrl.replace(/1(?=[^1]*$)/, response);
                    window.location.href = editDebtUrl;
                }
            })
        })
    });
</script>


{% endblock %}