{% extends "layout.html" %}
{% block content %}
<div class="row">
    <div class="col">
        <label for="class_" class="form-label">Razred:</label>
        <input class="form-control mb-2" type="text" id="class_" name="class_" value="{{ student.student_class }}" readonly>
    </div>
    <div class="col">
        <label for="student_section" class="form-label">Odeljenje:</label>
        <input class="form-control mb-2" type="text" id="student_section" name="student_section" value="{{ student.student_section }}" readonly>
    </div>
    <div class="col">
        <label for="start-date" class="form-label">Početni datum:</label>
        <input class="form-control mb-2" type="date" id="start-date" name="start-date" value="{{ start_date }}">
    </div>
    <div class="col">
        <label for="end-date" class="form-label">Krajnji datum:</label>
        <input class="form-control mb-4" type="date" id="end-date" name="end-date" value="{{ end_date }}">
    </div>
</div>
<hr>
{% for service in unique_services_list %}
    <legend>{{ service['service_name'] }}</legend>
    <table id="data" class="table table-striped dataTable no-footer invoices" role="grid">
        <thead>
            <tr>
                <th>ID record // ID usluge / Datum</th>
                <th>Opis usluge</th>
                <th>Zaduženje</th>
                <th>Uplate</th>
                <th>Saldo</th>
                <th>Štampa</th>
            </tr>
        </thead>
        <tbody>
            {% for record in data %}
            {% if record['service_item_id'] == service['id'] %}
            <tr>
                <td>{{ record['id'] }} // {{ record['service_item_id'] }} / {{ record['date'].strftime('%d.%m.%Y.') }}</td>
                <td>{{ record['description'] }}</td>
                <td>{{ record['debt_amount'] }}</td>
                <td>{{ record['payment_amount'] }}</td>
                <td>{{ record['saldo'] }}</td>
                <td>{% if record['debt_amount'] > 0 %} <button class="btn btn-primary">print</button> {% else %} <a href="{{ url_for('transactions.payment_archive', payment_id=record['student_payment_id'] ) }}" class="btn btn-primary">Izvod: {{ record['student_payment_id'] }}</a> {% endif %}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% endfor %}
    <hr>
    <div>
        <p>Zaduženje: <span id="zaduzenjeSum"></span></p>
        <p>Uplate: <span id="uplateSum"></span></p>
        <p>Saldo: <span id="saldoSum"></span></p>
    </div>

{% endblock content%}
{% block scripts %}
<script>
    // Dobijanje reference na HTML elemente koji će prikazivati sume
    var zaduzenjeSumElement = document.getElementById('zaduzenjeSum');
    var uplateSumElement = document.getElementById('uplateSum');
    var saldoSumElement = document.getElementById('saldoSum');

    // Izračunavanje sumi za svaki ključ
    var data = JSON.parse('{{ data | tojson | safe }}');
    var zaduzenjeSum = 0;
    var uplateSum = 0;
    var saldoSum = 0;

    for (var i = 0; i < data.length; i++) {
        zaduzenjeSum += data[i].debt_amount;
        uplateSum += data[i].payment_amount;
    }
    saldoSum = zaduzenjeSum - uplateSum;

    // Prikazivanje suma u HTML-u
    zaduzenjeSumElement.textContent = zaduzenjeSum;
    uplateSumElement.textContent = uplateSum;
    saldoSumElement.textContent = saldoSum;

    // Funkcija koja se poziva pri promeni datuma
    function handleDateChange() {
        var startDate = document.getElementById("start-date").value;
        var endDate = document.getElementById("end-date").value;
        var currentUrl = window.location.href.split('?')[0];
        var url = currentUrl + "?start_date=" + startDate + "&end_date=" + endDate;
        window.location.href = url; // Ponovno učitavanje stranice sa novim vrednostima datuma
    }

    // Dodavanje osluškivača događaja za promenu datuma
    document.getElementById("start-date").addEventListener("change", handleDateChange);
    document.getElementById("end-date").addEventListener("change", handleDateChange);
</script>
{% endblock %}